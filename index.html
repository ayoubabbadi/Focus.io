<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default: Neutral */
            --bg-color: #000000;
            --text-glow: 0 0 5px #c8c8c8, 0 0 10px #c8c8c8, 0 0 20px #c8c8c8;
            --text-glow-dim: 0 0 5px #555, 0 0 10px #555;
            --font-digital: 'Orbitron', sans-serif;
            --font-ui: 'Roboto', sans-serif;
        }

        body {
            font-family: var(--font-ui); /* Use Roboto for UI */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            cursor: default;
            user-select: none;
            background-color: var(--bg-color);
            transition: background-color 0.5s ease;
        }
        
        body.state-focus { --bg-color: #2a0000; }
        body.state-break { --bg-color: #001f3f; }

        .timer-text {
            font-family: var(--font-digital); /* Use Orbitron for timer */
            text-shadow: var(--text-glow);
            transition: text-shadow 0.5s ease;
        }
        body.state-focus .timer-text { --text-glow: 0 0 5px #ff4d4d, 0 0 10px #ff4d4d, 0 0 20px #ff4d4d; }
        body.state-break .timer-text { --text-glow: 0 0 5px #00aaff, 0 0 10px #00aaff, 0 0 20px #00aaff; }

        .session-text {
            font-family: var(--font-digital);
            text-shadow: var(--text-glow-dim);
            transition: text-shadow 0.5s ease;
        }
        body.state-focus .session-text { --text-glow-dim: 0 0 5px #803333; }
        body.state-break .session-text { --text-glow-dim: 0 0 5px #335b80; }

        .mode-btn {
            @apply bg-gray-800 text-gray-400 font-bold py-2 px-6 rounded-lg uppercase tracking-wider text-lg transition-all;
            font-family: var(--font-digital);
        }
        .mode-btn:hover { @apply bg-gray-700 text-white; }
        .mode-btn-active { @apply bg-white text-black; }

        .modal-overlay { @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center; }
        .modal-content { @apply bg-gray-900 p-8 rounded-lg shadow-xl text-left; }
        .modal-content label { @apply block text-gray-400 text-sm font-bold mb-2; }
        .modal-content input { @apply bg-gray-700 text-white p-2 rounded w-full mb-4; }

        /* --- New Task List Styles --- */
        #task-container {
            @apply w-full max-w-md bg-gray-900 bg-opacity-50 p-6 rounded-lg shadow-lg mt-8;
        }
        #new-task-input {
            @apply w-full bg-gray-800 text-white p-3 rounded-lg border-2 border-gray-700 focus:outline-none focus:border-blue-500;
            font-family: var(--font-ui);
        }
        #task-list { @apply list-none p-0 mt-4 max-h-48 overflow-y-auto; }
        .task-item {
            @apply flex items-center justify-between p-3 bg-gray-800 rounded-lg mb-2 transition-all;
        }
        .task-item.completed .task-name { @apply line-through text-gray-500; }
        .task-item.selected { @apply bg-blue-900; }

        .task-name { @apply text-lg; }
        .task-pomodoros { @apply text-sm text-gray-400 mr-2; font-family: var(--font-digital); }
        .task-actions button { @apply bg-gray-700 hover:bg-gray-600 p-2 rounded-md ml-1; }
        .task-actions button:hover { @apply text-white; }
    </style>
</head>

<body class="text-white flex items-center justify-center h-screen overflow-hidden">
    <audio id="alarm-sound" src="data:audio/mpeg;base64,..."></audio>

    <button id="settings-btn" class="absolute top-4 right-6 text-3xl opacity-50 hover:opacity-100 transition-opacity">
        ‚öôÔ∏è
    </button>

    <div class="flex flex-col items-center justify-center">

        <div class="text-center p-4">
            <div id="current-task-display" class="h-8 text-xl text-gray-400 mb-2 truncate" title="No task selected">
                No task selected
            </div>
            
            <div class="flex space-x-2 md:space-x-4 justify-center mb-8">
                <button id="focus-btn" class="mode-btn mode-btn-active">Focus</button>
                <button id="short-btn" class="mode-btn">Short Break</button>
                <button id="long-btn" class="mode-btn">Long Break</button>
            </div>

            <div id="timer-display" class="timer-text text-8xl md:text-9xl font-bold tracking-widest mb-10">
                25:00
            </div>

            <div class="flex space-x-4 justify-center mb-8">
                <button id="start-pause-btn" class="bg-white hover:bg-gray-200 text-black font-bold py-3 px-12 rounded-lg uppercase tracking-wider text-2xl transition-all">
                    Start
                </button>
                <button id="skip-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg uppercase tracking-wider text-2xl transition-all" title="Skip to next session">
                    ¬ª
                </button>
            </div>

            <div id="session-count" class="session-text text-gray-400 text-xl tracking-wider">
                Session: 1 of 4
            </div>
        </div>

        <div id="task-container">
            <div class="flex space-x-2">
                <input type="text" id="new-task-input" placeholder="Add a new task...">
                <button id="add-task-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold p-3 rounded-lg">
                    Add
                </button>
            </div>
            <ul id="task-list">
                </ul>
        </div>
    </div>


    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content w-96">
            <h2 class="text-2xl font-bold mb-6">Settings</h2>
            <div class="grid grid-cols-2 gap-4">
                <div><label for="focus-time">Focus (min)</label><input type="number" id="focus-time" min="1"></div>
                 <div><label for="short-time">Short Break (min)</label><input type="number" id="short-time" min="1"></div>
                <div><label for="long-time">Long Break (min)</label><input type="number" id="long-time" min="1"></div>
                <div><label for="sessions">Sessions</label><input type="number" id="sessions" min="1"></div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="close-settings-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-6 rounded-lg">Cancel</button>
                <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- Timer DOM Elements ---
        const timerDisplay = document.getElementById('timer-display');
        const focusBtn = document.getElementById('focus-btn');
        const shortBtn = document.getElementById('short-btn');
        const longBtn = document.getElementById('long-btn');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const skipBtn = document.getElementById('skip-btn');
        const sessionCountDisplay = document.getElementById('session-count');
        const alarmSound = document.getElementById('alarm-sound');
        const bodyElement = document.body;
        const currentTaskDisplay = document.getElementById('current-task-display');

        // --- Settings Modal Elements ---
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const focusTimeInput = document.getElementById('focus-time');
        const shortTimeInput = document.getElementById('short-time');
        const longTimeInput = document.getElementById('long-time');
        const sessionsInput = document.getElementById('sessions');

        // --- New Task DOM Elements ---
        const newTaskInput = document.getElementById('new-task-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const taskList = document.getElementById('task-list');

        // --- Timer State ---
        let POMODORO_TIMES = { focus: 25 * 60, short: 5 * 60, long: 15 * 60 };
        let SESSIONS_UNTIL_LONG_BREAK = 4;
        let timerInterval;
        let isTimerRunning = false;
        let currentMode = 'focus';
        let currentTimeInSeconds = POMODORO_TIMES.focus;
        let sessionCount = 0;
        let hasNotificationPermission = false;

        // --- New Task State ---
        let tasks = [];
        let currentTaskId = null;

        // --- Timer Functions (Unchanged) ---
        function formatTime(seconds) {
            const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
            const remainingSeconds = String(seconds % 60).padStart(2, '0');
            return `${minutes}:${remainingSeconds}`;
        }

        function updateTimerDisplay() {
            const timeString = formatTime(currentTimeInSeconds);
            timerDisplay.textContent = timeString;
            document.title = `${timeString} - ${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)}`;
        }

        function startTimer() {
            isTimerRunning = true;
            startPauseBtn.textContent = 'Pause';
            bodyElement.classList.remove('state-focus', 'state-break');
            if (currentMode === 'focus') {
                bodyElement.classList.add('state-focus');
            } else {
                bodyElement.classList.add('state-break');
            }

            timerInterval = setInterval(() => {
                currentTimeInSeconds--;
                updateTimerDisplay();

                if (currentTimeInSeconds <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    alarmSound.play();
                    // --- Updated: Increment Pomodoro on task ---
                    if (currentMode === 'focus' && currentTaskId) {
                        incrementTaskPomodoro(currentTaskId);
                    }
                    autoSwitchMode();
                }
            }, 1000);
        }

        function pauseTimer() {
            isTimerRunning = false;
            startPauseBtn.textContent = 'Start';
            clearInterval(timerInterval);
        }

        function toggleStartPause() {
            if (!hasNotificationPermission) {
                requestNotificationPermission();
                hasNotificationPermission = true;
            }
            if (isTimerRunning) { pauseTimer(); } else { startTimer(); }
        }

        function updateSessionDisplay() {
            const displayCount = sessionCount % SESSIONS_UNTIL_LONG_BREAK;
            const totalSessions = SESSIONS_UNTIL_LONG_BREAK;
            if (displayCount === 0 && sessionCount !== 0) {
                sessionCountDisplay.textContent = `Session: ${totalSessions} of ${totalSessions}`;
            } else {
                sessionCountDisplay.textContent = `Session: ${displayCount} of ${totalSessions}`;
            }
        }

        function sendNotification(nextMode) {
            if (Notification.permission !== 'granted') return;
            const title = "Pomodoro Timer";
            let body;
            if (nextMode === 'focus') { body = "Time to focus!"; }
            else if (nextMode === 'short') { body = "Time for a short break!"; }
            else { body = "Time for a long break!"; }
            new Notification(title, { body: body });
        }

        function autoSwitchMode() {
            let nextMode;
            if (currentMode === 'focus') {
                sessionCount++;
                updateSessionDisplay();
                nextMode = (sessionCount % SESSIONS_UNTIL_LONG_BREAK === 0) ? 'long' : 'short';
            } else {
                nextMode = 'focus';
            }
            sendNotification(nextMode);
            setMode(nextMode);
            startTimer();
        }

        function setMode(mode) {
            currentMode = mode;
            pauseTimer();
            currentTimeInSeconds = POMODORO_TIMES[mode];
            updateTimerDisplay();
            bodyElement.classList.remove('state-focus', 'state-break');
            focusBtn.classList.toggle('mode-btn-active', mode === 'focus');
            shortBtn.classList.toggle('mode-btn-active', mode === 'short');
            longBtn.classList.toggle('mode-btn-active', mode === 'long');
            if (mode === 'focus') {
                bodyElement.classList.add('state-focus');
                updateSessionDisplay();
            } else {
                bodyElement.classList.add('state-break');
                sessionCountDisplay.textContent = 'Time for a break!';
            }
        }

        function skipSession() {
            pauseTimer();
            // Manually increment pomodoro if skipping a focus session
            if (currentMode === 'focus' && currentTaskId) {
                incrementTaskPomodoro(currentTaskId);
            }
            autoSwitchMode();
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission !== 'denied' && Notification.permission !== 'granted') {
                Notification.requestPermission().then(p => { hasNotificationPermission = (p === 'granted'); });
            } else {
                hasNotificationPermission = (Notification.permission === 'granted');
            }
        }

        // --- Settings Logic (Unchanged) ---
        function openSettings() {
            focusTimeInput.value = POMODORO_TIMES.focus / 60;
            shortTimeInput.value = POMODORO_TIMES.short / 60;
            longTimeInput.value = POMODORO_TIMES.long / 60;
            sessionsInput.value = SESSIONS_UNTIL_LONG_BREAK;
            settingsModal.classList.remove('hidden');
        }
        function closeSettings() { settingsModal.classList.add('hidden'); }
        function saveSettings() {
            const settings = {
                focus: parseInt(focusTimeInput.value) * 60,
                short: parseInt(shortTimeInput.value) * 60,
                long: parseInt(longTimeInput.value) * 60,
                sessions: parseInt(sessionsInput.value)
            };
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));
            applySettings(settings);
            closeSettings();
        }
        function applySettings(settings) {
            if (!settings) return;
            POMODORO_TIMES = { focus: settings.focus, short: settings.short, long: settings.long };
            SESSIONS_UNTIL_LONG_BREAK = settings.sessions;
            setMode('focus');
            updateSessionDisplay();
        }
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('pomodoroSettings'));
            if (settings) { applySettings(settings); }
        }

        // --- New Task Functions ---
        
        /** Renders the entire task list */
        function renderTasks() {
            taskList.innerHTML = ''; // Clear existing list
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<li class="text-gray-500 text-center p-3">No tasks yet.</li>';
                return;
            }

            tasks.forEach(task => {
                if (task.completed) return; // Don't show completed tasks

                const li = document.createElement('li');
                li.className = 'task-item';
                li.dataset.id = task.id;
                
                if (task.id === currentTaskId) {
                    li.classList.add('selected');
                }

                li.innerHTML = `
                    <span class="task-name">${task.name}</span>
                    <div class="flex items-center">
                        <span class="task-pomodoros">[${task.pomodoros}]</span>
                        <div class="task-actions">
                            <button class="select-task-btn" title="Focus on this task">üéØ</button>
                            <button class="complete-task-btn" title="Complete task">‚úîÔ∏è</button>
                        </div>
                    </div>
                `;
                taskList.appendChild(li);
            });
        }

        /** Adds a new task */
        function addTask() {
            const name = newTaskInput.value.trim();
            if (name) {
                const newTask = {
                    id: Date.now().toString(),
                    name: name,
                    completed: false,
                    pomodoros: 0
                };
                tasks.push(newTask);
                saveTasks();
                renderTasks();
                newTaskInput.value = '';
            }
        }

        /** Selects a task to focus on */
        function selectTask(id) {
            currentTaskId = id;
            const task = tasks.find(t => t.id === id);
            if (task) {
                currentTaskDisplay.textContent = `Focusing on: ${task.name}`;
                currentTaskDisplay.title = `Focusing on: ${task.name}`;
            }
            renderTasks(); // Re-render to show selection
        }

        /** Marks a task as complete */
        function completeTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = true;
                if (currentTaskId === id) {
                    currentTaskId = null;
                    currentTaskDisplay.textContent = 'No task selected';
                    currentTaskDisplay.title = 'No task selected';
                }
                saveTasks();
                renderTasks();
            }
        }

        /** Increments the pomodoro count for a task */
        function incrementTaskPomodoro(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.pomodoros++;
                saveTasks();
                renderTasks();
            }
        }

        /** Saves all tasks to localStorage */
        function saveTasks() {
            localStorage.setItem('pomodoroTasks', JSON.stringify(tasks));
        }

        /** Loads tasks from localStorage */
        function loadTasks() {
            const savedTasks = JSON.parse(localStorage.getItem('pomodoroTasks'));
            if (savedTasks) {
                tasks = savedTasks;
            }
            // Filter out completed tasks from the active list on load
            tasks = tasks.filter(task => !task.completed);
            renderTasks();
        }

        // --- Event Listeners ---
        startPauseBtn.addEventListener('click', toggleStartPause);
        skipBtn.addEventListener('click', skipSession);
        focusBtn.addEventListener('click', () => setMode('focus'));
        shortBtn.addEventListener('click', () => setMode('short'));
        longBtn.addEventListener('click', () => setMode('long'));

        // Settings
        settingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        saveSettingsBtn.addEventListener('click', saveSettings);

        // Tasks
        addTaskBtn.addEventListener('click', addTask);
        newTaskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { addTask(); }
        });

        // Task list event delegation
        taskList.addEventListener('click', (e) => {
            const target = e.target;
            const taskItem = target.closest('.task-item');
            if (!taskItem) return;
            
            const id = taskItem.dataset.id;
            
            if (target.closest('.select-task-btn')) {
                selectTask(id);
            }
            if (target.closest('.complete-task-btn')) {
                completeTask(id);
            }
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && document.activeElement !== newTaskInput) {
                e.preventDefault();
                toggleStartPause();
            }
        });

        // --- Initial Setup ---
        loadSettings(); // Load saved timer settings
        loadTasks(); // Load saved tasks
        setMode('focus'); // Start on 'focus' mode

    </script>
</body>
</html>